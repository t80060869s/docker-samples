# Работа с миграциями Alembic

Этот документ описывает процесс создания и применения миграций базы данных с помощью Alembic в данном проекте. Alembic используется для отслеживания и применения изменений схемы базы данных, которые соответствуют моделям SQLAlchemy в приложении.

## Основные принципы

- **Одна миграция — одно логическое изменение.** Старайтесь, чтобы каждая миграция выполняла одну задачу (например, "добавление таблицы пользователей" или "добавление поля `last_name` в `users`").
- **Все команды выполняются внутри Docker-контейнера `fastapi`.**

Для доступа к командной строке контейнера выполните:
```bash
docker-compose exec fastapi bash
```
Все последующие команды в этом руководстве предполагают, что вы находитесь внутри этого контейнера и находитесь в каталоге `backend` (с помощью команды `cd backend`).

---

## 1. Создание миграций

### Автоматическая генерация (рекомендуемый способ)

Это основной способ создания миграций. Alembic автоматически сравнит состояние ваших моделей SQLAlchemy с текущим состоянием схемы в базе данных и сгенерирует файл миграции с необходимыми изменениями.

1.  **Внесите изменения** в файлы моделей (например, `backend/app/db/models/user.py`).
2.  **Выполните команду** для автогенерации:
    ```bash
    alembic revision --autogenerate -m "Краткое описание изменений"
    ```
    - `--autogenerate`: Ключевой флаг, запускающий сравнение.
    - `-m "..."`: Ваше сообщение, которое станет частью имени файла и описанием коммита. **Всегда пишите осмысленные сообщения!**

**Пример:**
```bash
alembic revision --autogenerate -m "Add phone_number to User model"
```
После этого в директории `backend/alembic/versions/` появится новый файл, например, `20250921_a1b2c3d4e5f6_add_phone_number_to_user_model.py`.

3.  **Обязательно проверьте** сгенерированный файл. Иногда Alembic может ошибаться, особенно со сложными типами данных или ограничениями. Убедитесь, что код в функциях `upgrade()` и `downgrade()` соответствует вашим ожиданиям.

### Ручное создание миграции

Используется редко, в основном для сложных миграций, которые не связаны с изменением схемы (например, миграция данных, исправление некорректных записей).

1.  **Выполните команду:**
    ```bash
    alembic revision -m "Manual data migration for users"
    ```
2.  Alembic создаст пустой файл миграции с функциями `upgrade()` и `downgrade()`.
3.  **Напишите код** для миграции вручную, используя `op.execute()` или другие операторы Alembic.

---

## 2. Применение миграций (Upgrade)

### Автоматическое применение при старте (в режиме разработки)

В файле `docker-compose.dev.yaml` для сервиса `fastapi` прописана команда, которая автоматически применяет все новые миграции при каждом запуске контейнера.

```yaml
# ...
command: sh -c "... &&
         alembic upgrade head &&
         uvicorn main:app --host 0.0.0.0 --port 8000 --reload"
```
- `alembic upgrade head`: Эта команда обновляет схему БД до самой последней (`head`) версии миграции.

Это очень удобно для разработки: вы создали миграцию, перезапустили контейнер (`docker-compose restart fastapi`), и она автоматически применилась.

### Ручное применение

Необходимо для управления миграциями на production-сервере или для отладки.

- **Применить все миграции:**
  ```bash
  alembic upgrade head
  ```
- **Применить следующую миграцию (+1 от текущей):**
  ```bash
  alembic upgrade +1
  ```
- **Применить миграции до конкретной версии:**
  ```bash
  alembic upgrade <revision_id>
  ```

---

## 3. Откат миграций (Downgrade)

> **Внимание!** Откат миграций — это потенциально деструктивная операция, которая может привести к потере данных. Используйте с осторожностью, особенно на production.

- **Откатить последнюю примененную миграцию (-1 от текущей):**
  ```bash
  alembic downgrade -1
  ```
- **Откатить все миграции (до пустого состояния):**
  ```bash
  alembic downgrade base
  ```
- **Откатить миграции до конкретной версии:**
  ```bash
  alembic downgrade <revision_id>
  ```
  Эта команда откатит все миграции, которые были применены *после* указанной `revision_id`.

---

## 4. Полезные команды для диагностики

- **Показать текущую версию БД:**
  ```bash
  alembic current
  ```
- **Показать всю историю миграций и их статус:**
  ```bash
  alembic history
  ```
- **Показать детали конкретной миграции:**
  ```bash
  alembic show <revision_id>
  ```
